#!/bin/bash

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Функции для логирования
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}
error() {
    echo -e "${RED}[ERROR] $1${NC}"
}
warn() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}
info() {
    echo -e "${BLUE}[INFO] $1${NC}"
}
prompt() {
    echo -e "${CYAN}[INPUT] $1${NC}"
}

# Проверка прав root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "Этот скрипт должен быть запущен с правами root"
        exit 1
    fi
}

# Главное меню
main_menu() {
    while true; do
        echo ""
        info "Главное меню:"
        echo "1) Настройка DHCP-сервера"
        echo "2) Удалить DHCP-сервер"
        echo "3) Настройка DNS"
        echo "4) Удалить DNS"
        echo "5) Выход"
        prompt "Выберите действие (1-5): "
        read -r choice

        case $choice in
            1) configure_dhcp ;;
            2) remove_dhcp ;;
            3) configure_dns ;;
            4) remove_dns ;;
            5) break ;;
            *) warn "Неверный выбор. Введите число от 1 до 5." ;;
        esac
    done
}

# Функция: настройка DHCP-сервера
configure_dhcp() {
    log "Проверка наличия isc-dhcp-server..."
    if ! command -v dhcpd &>/dev/null; then
        log "Установка isc-dhcp-server..."
        apt update
        apt install -y isc-dhcp-server
    fi

    # Получение интерфейса
    get_interfaces
    echo ""
    info "Доступные сетевые интерфейсы:"
    for i in "${!interfaces[@]}"; do
        echo "  $((i+1))) ${interfaces[$i]}"
    done

    while true; do
        prompt "Выберите интерфейс для работы DHCP (1-${#interfaces[@]}): "
        read -r choice
        if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#interfaces[@]} ]]; then
            selected_interface=${interfaces[$((choice-1))]}
            break
        else
            error "Неверный выбор. Введите число от 1 до ${#interfaces[@]}"
        fi
    done

    # Запрос параметров
    prompt "Введите IP-адрес подсети (например, 192.168.1.0/24): "
    read -r subnet_ip

    prompt "Введите начало диапазона выдачи IP (например, 192.168.1.100): "
    read -r start_ip

    prompt "Введите конец диапазона выдачи IP (например, 192.168.1.200): "
    read -r end_ip

    prompt "Введите шлюз по умолчанию (например, 192.168.1.1): "
    read -r gateway

    prompt "Введите DNS-сервер (например, 8.8.8.8): "
    read -r dns_server

    log "Настройка DHCP-сервера..."

    cat > /etc/dhcp/dhcpd.conf <<EOF
subnet $subnet_ip netmask $(ipcalc -n $subnet_ip | cut -d= -f2) {
  range $start_ip $end_ip;
  option routers $gateway;
  option domain-name-servers $dns_server;
  default-lease-time 600;
  max-lease-time 7200;
}
EOF

    echo "INTERFACES=\"$selected_interface\"" > /etc/default/isc-dhcp-server

    systemctl restart isc-dhcp-server
    systemctl enable isc-dhcp-server

    log "DHCP-сервер настроен!"
}

# Функция: удаление DHCP-сервера
remove_dhcp() {
    log "Удаление DHCP-сервера..."
    if ! command -v dhcpd &>/dev/null; then
        warn "DHCP-сервер не установлен."
        return
    fi

    systemctl stop isc-dhcp-server
    systemctl disable isc-dhcp-server

    rm -f /etc/dhcp/dhcpd.conf
    rm -f /etc/default/isc-dhcp-server

    apt purge -y isc-dhcp-server isc-dhcp-server-bin isc-dhcp-common
    apt autoremove -y

    log "DHCP-сервер удален!"
}

# Функция: настройка DNS
configure_dns() {
    prompt "Введите IP-адрес DNS-сервера: "
    read -r dns_ip

    log "Настройка DNS на устройстве..."
    echo "nameserver $dns_ip" > /etc/resolv.conf

    log "DNS настроен!"
}

# Функция: удаление DNS
remove_dns() {
    log "Удаление DNS настроек..."
    echo "" > /etc/resolv.conf

    log "DNS настройки удалены!"
}

# Функция: получить список интерфейсов
get_interfaces() {
    interfaces=($(ip link show | awk -F: '$0 !~ "lo|vir|wl|^[^0-9]"{print $2}' | sed 's/^ *//'))
    if [[ ${#interfaces[@]} -eq 0 ]]; then
        error "Не найдено сетевых интерфейсов"
        exit 1
    fi
}

# Главное меню
main_menu
