#!/bin/bash

# Цвета
R='\033[0;31m'; G='\033[0;32m'; Y='\033[1;33m'; B='\033[0;34m'; NC='\033[0m'

# Логирование
log() { echo -e "${B}[INFO] $1${NC}"; }
err() { echo -e "${R}[ERROR] $1${NC}"; }
warn() { echo -e "${Y}[WARN] $1${NC}"; }

# Проверка root
[[ $EUID -ne 0 ]] && { err "Запустите с правами root"; exit 1; }

# Отключение NetworkManager
disable_nm() {
    log "Отключение NetworkManager..."
    systemctl stop NetworkManager 2>/dev/null
    systemctl disable NetworkManager 2>/dev/null
    systemctl mask NetworkManager 2>/dev/null
    log "NetworkManager отключен"
}

# Получение интерфейсов
get_interfaces() {
    interfaces=($(ip link show | awk -F: '$0 !~ "lo|vir|wl|^[^0-9]"{print $2}' | sed 's/^ *//'))
    [[ ${#interfaces[@]} -eq 0 ]] && { err "Интерфейсы не найдены"; exit 1; }
}

# Настройка IP
setup_ip() {
    get_interfaces
    echo -e "\n${B}Интерфейсы:${NC}"
    for i in "${!interfaces[@]}"; do
        echo "  $((i+1))) ${interfaces[$i]}"
    done

    while true; do
        read -p "Выберите интерфейс (1-${#interfaces[@]}): " choice
        [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#interfaces[@]} ]] && break
        warn "Неверный выбор"
    done
    
    iface=${interfaces[$((choice-1))]}
    read -p "IP адрес: " ip
    read -p "Маска (CIDR): " mask
    read -p "Шлюз: " gw
    read -p "DNS: " dns

    log "Настройка $iface..."
    ip addr flush dev $iface
    ip addr add ${ip}/${mask} dev $iface
    ip link set $iface up
    ip route add default via $gw 2>/dev/null
    echo "nameserver $dns" > /etc/resolv.conf
    log "IP настроен!"
}

# Смена hostname
change_host() {
    hosts=("isp.au-team.irpo" "hq-rtr.au-team.irpo" "br-rtr.au-team.irpo" "hq-srv.au-team.irpo" "hq-cli.au-team.irpo" "br-srv.au-team.irpo")
    echo -e "\n${B}Выберите hostname:${NC}"
    for i in "${!hosts[@]}"; do
        echo "  $((i+1))) ${hosts[$i]}"
    done
    echo "  $((${#hosts[@]}+1))) Ввести свой"

    read -p "Выбор: " choice
    if [[ "$choice" -le ${#hosts[@]} ]]; then
        hostname=${hosts[$((choice-1))]}
    else
        read -p "Введите hostname: " hostname
    fi

    hostnamectl set-hostname "$hostname"
    log "Hostname: $hostname"
    exec bash
}

# Маскарадинг
setup_nat() {
    get_interfaces
    echo -e "\n${B}Выберите внешний интерфейс:${NC}"
    for i in "${!interfaces[@]}"; do
        echo "  $((i+1))) ${interfaces[$i]}"
    done

    read -p "Выбор: " choice
    iface=${interfaces[$((choice-1))]}

    log "Настройка NAT..."
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
    sysctl -p >/dev/null
    iptables -t nat -A POSTROUTING -o $iface -j MASQUERADE
    
    if command -v apt >/dev/null; then
        apt update >/dev/null 2>&1
        DEBIAN_FRONTEND=noninteractive apt install -y iptables-persistent >/dev/null 2>&1
        netfilter-persistent save >/dev/null 2>&1
    fi
    log "NAT настроен!"
}

# Проверки
check_net() {
    echo -e "\n${B}1)${NC} IP адреса  ${B}2)${NC} Порты  ${B}3)${NC} Ping 8.8.8.8"
    read -p "Выбор: " choice
    case $choice in
        1) ip -c a ;;
        2) ss -tuln 2>/dev/null || netstat -tuln ;;
        3) ping -c 3 8.8.8.8 ;;
    esac
}

# Главное меню
while true; do
    echo -e "\n${G}=== Настройка сети ===${NC}"
    echo "1) Настроить IP"
    echo "2) Сменить hostname" 
    echo "3) Настроить NAT"
    echo "4) Проверки"
    echo "5) Выход"
    read -p "Выбор: " choice

    case $choice in
        1) disable_nm; setup_ip ;;
        2) change_host ;;
        3) setup_nat ;;
        4) check_net ;;
        5) break ;;
        *) warn "Неверный выбор" ;;
    esac
done
