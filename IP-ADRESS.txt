#!/bin/bash

# Проверка прав root
if [[ $EUID -ne 0 ]]; then
    echo "Этот скрипт должен быть запущен с правами root" 
    exit 1
fi

# Отключение NetworkManager
echo "Отключение NetworkManager..."
systemctl stop NetworkManager
systemctl disable NetworkManager

# Получение списка доступных интерфейсов
echo "Доступные сетевые интерфейсы:"
interfaces=($(ip link show | awk -F: '$0 !~ "lo|vir|wl|^[^0-9]"{print $2}' | sed 's/^ *//'))
if [[ ${#interfaces[@]} -eq 0 ]]; then
    echo "Ошибка: Нет доступных сетевых интерфейсов."
    exit 1
fi

# Вывод списка интерфейсов для выбора
for i in "${!interfaces[@]}"; do
    echo "  $((i+1))) ${interfaces[$i]}"
done

# Запрос выбора интерфейса
while true; do
    read -p "Выберите номер интерфейса (1-${#interfaces[@]}): " choice
    if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#interfaces[@]} ]]; then
        interface=${interfaces[$((choice-1))]}
        break
    else
        echo "Неверный выбор. Пожалуйста, введите число от 1 до ${#interfaces[@]}."
    fi
done

# Запрос сетевых настроек
read -p "Введите IP адрес для $interface: " ip
read -p "Введите маску (CIDR, например, 24): " mask
read -p "Введите шлюз: " gateway
read -p "Введите DNS сервер: " dns

# Применение настроек
echo "Применение настроек для интерфейса $interface..."
ip addr flush dev $interface
ip addr add ${ip}/${mask} dev $interface
ip link set $interface up
ip route add default via $gateway
echo "nameserver $dns" > /etc/resolv.conf

# Проверка подключения
echo "Проверка подключения через ping 8.8.8.8..."
ping -c 3 8.8.8.8 || echo "Подключение к интернету недоступно."

# Настройка IP-форвардинга и маскарадинга
echo "Настройка IP-форвардинга и маскарадинга..."

# Включение IP-форвардинга
echo "Включение IP-форвардинга в /etc/sysctl.conf..."
if grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    echo "IP-форвардинг уже включен."
else
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
    sysctl -p
    echo "IP-форвардинг включен."
fi

# Настройка маскарадинга
echo "Настройка маскарадинга для интерфейса $interface..."
iptables -t nat -A POSTROUTING -o $interface -j MASQUERADE
echo "Маскарадинг настроен."

# Установка iptables-persistent
echo "Установка iptables-persistent..."
apt update
DEBIAN_FRONTEND=noninteractive apt install -y iptables-persistent
echo "iptables-persistent установлен."

# Сохранение правил iptables
echo "Сохранение правил iptables..."
netfilter-persistent save
echo "Правила iptables сохранены."

echo "Настройка завершена!"





#!/bin/bash

# Проверка прав root
if [[ $EUID -ne 0 ]]; then
    echo "Этот скрипт должен быть запущен с правами root"
    exit 1
fi

# Получение списка доступных интерфейсов
echo "Доступные сетевые интерфейсы:"
interfaces=($(ip link show | awk -F: '$0 !~ "lo|vir|wl|^[^0-9]"{print $2}' | sed 's/^ *//'))
if [[ ${#interfaces[@]} -eq 0 ]]; then
    echo "Ошибка: Нет доступных сетевых интерфейсов."
    exit 1
fi

# Вывод списка интерфейсов для выбора
for i in "${!interfaces[@]}"; do
    echo "  $((i+1))) ${interfaces[$i]}"
done

# Запрос выбора интерфейса
while true; do
    read -p "Выберите номер интерфейса (1-${#interfaces[@]}): " choice
    if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#interfaces[@]} ]]; then
        interface=${interfaces[$((choice-1))]}
        break
    else
        echo "Неверный выбор. Пожалуйста, введите число от 1 до ${#interfaces[@]}."
    fi
done

# Сброс настроек для выбранного интерфейса
echo "Сброс настроек для интерфейса $interface..."
ip addr flush dev $interface
ip route flush dev $interface
ip link set $interface down
ip link set $interface up

# Очистка DNS
echo "Очистка DNS..."
echo "" > /etc/resolv.conf

# Включение NetworkManager
echo "Включение NetworkManager..."
systemctl enable NetworkManager
systemctl start NetworkManager

# Проверка подключения
echo "Проверка подключения через ping 8.8.8.8..."
ping -c 3 8.8.8.8 || echo "Подключение к интернету недоступно."

echo "Настройки сети для интерфейса $interface сброшены!"

echo "Настройка завершена!"
