#!/bin/bash

# Цвета для вывода
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m' # Яркий цвет для главного меню
NC='\033[0m'

# Функции для логирования
log() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}
error() {
    echo -e "${RED}[ERROR] $1${NC}"
}
warn() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}
info() {
    echo -e "${MAGENTA}[INFO] $1${NC}" # Изменён цвет на яркий
}
prompt() {
    echo -e "${YELLOW}[INPUT] $1${NC}"
}

# Проверка прав root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "Этот скрипт должен быть запущен с правами root"
        exit 1
    fi
}

# Отключение NetworkManager
disable_networkmanager() {
    log "Отключение NetworkManager..."
    systemctl stop NetworkManager
    systemctl disable NetworkManager
    systemctl mask NetworkManager
    log "NetworkManager полностью отключен"
}

# Получение списка сетевых интерфейсов
get_interfaces() {
    interfaces=($(ip link show | awk -F: '$0 !~ "lo|vir|wl|^[^0-9]"{print $2}' | sed 's/^ *//'))
    if [[ ${#interfaces[@]} -eq 0 ]]; then
        error "Не найдено сетевых интерфейсов"
        exit 1
    fi
}

# Сохранение сетевых настроек через systemd-networkd
save_network_config() {
    local interface=$1
    local ip_address=$2
    local netmask=$3
    local gateway=$4
    local dns1=$5
    local dns2=$6

    log "Сохранение сетевых настроек для интерфейса $interface..."

    # Создание конфигурации systemd-networkd
    cat > /etc/systemd/network/10-static-$interface.network << EOF
[Match]
Name=$interface

[Network]
Address=$ip_address/$netmask
Gateway=$gateway
DNS=$dns1
EOF

    # Добавление второго DNS, если он указан
    if [[ -n "$dns2" ]]; then
        echo "DNS=$dns2" >> /etc/systemd/network/10-static-$interface.network
    fi

    # Включение и перезапуск systemd-networkd
    systemctl enable systemd-networkd
    systemctl restart systemd-networkd

    log "Настройки для интерфейса $interface сохранены и будут применены при перезагрузке."
}

# Настройка статического IP
configure_static_ip() {
    get_interfaces
    echo ""
    info "Доступные сетевые интерфейсы:"
    for i in "${!interfaces[@]}"; do
        echo "  $((i+1))) ${interfaces[$i]}"
    done

    while true; do
        prompt "Выберите интерфейс для настройки (1-${#interfaces[@]}): "
        read -r choice
        if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le ${#interfaces[@]} ]]; then
            selected_interface=${interfaces[$((choice-1))]}
            break
        else
            error "Неверный выбор. Введите число от 1 до ${#interfaces[@]}"
        fi
    done

    read -p "Введите IP адрес: " ip
    read -p "Введите маску (CIDR, например, 24): " mask
    read -p "Введите шлюз: " gateway
    read -p "Введите DNS сервер: " dns

    log "Применение настроек для интерфейса $selected_interface..."
    ip addr flush dev $selected_interface
    ip addr add ${ip}/${mask} dev $selected_interface
    ip link set $selected_interface up
    ip route add default via $gateway
    echo "nameserver $dns" > /etc/resolv.conf

    # Вызов функции сохранения настроек
    save_network_config "$selected_interface" "$ip" "$mask" "$gateway" "$dns"

    log "Настройка завершена!"
}

# ... [Остальной код остается без изменений]

# Главное меню
main_menu() {
    while true; do
        echo ""
        info "Главное меню:"
        echo "1) Настройка статического IP"
        echo "2) Изменение имени хоста"
        echo "3) Настройка маскарадинга"
        echo "4) Проверка интернета"
        echo "5) Проверка соединений"
        echo "6) Управление пользователями"
        echo "7) SSH подключение"
        echo "8) Сброс настроек"
        echo "9) Выход"
        prompt "Выберите действие (1-9): "
        read -r choice

        case $choice in
            1) configure_static_ip ;;
            2) change_hostname_menu ;;
            3) configure_masquerade ;;
            4) test_internet_connection ;;
            5) check_connections_menu ;;
            6) create_user_menu ;;
            7) ssh_connection ;;
            8) reset_settings_menu ;;
            9) break ;;
            *) warn "Неверный выбор. Введите число от 1 до 9." ;;
        esac
    done
}

# Запуск скрипта
check_root
main_menu
